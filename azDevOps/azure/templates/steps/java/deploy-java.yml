parameters:
  repo_root_dir: ""
  project_root_dir: ""
  pipeline_scripts_directory: ""
  # Docker Config
  docker_build_container: ""
  # Project
  project_type: ""
  build_type: ""
  # MAVEN CENTRAL
  maven_id: "central"
  maven_username: ""
  maven_password: ""
  maven_package_version: ""
  # GPG KEYS
  gpg_key_signing_id: ""
  gpg_private_key: ""

steps:
  - bash: |
      echo "signing key: ${{ parameters.gpg_key_signing_id }}"
      base64 -d <<< "$gpg_private_key" > gpg_private_key.asc
      gpg --import  gpg_private_key.asc
      gpg --list-secret-keys --with-subkey-fingerprint
    target:
      container: ${{ parameters.docker_build_container }}
    env:
      gpg_private_key: "${{ parameters.gpg_private_key }}"
    displayName: "Retrieve and import gpg key from key vault"

  - task: Bash@3
    inputs:
      targetType: inline
      script: |
        echo '<settings xmlns="http://maven.apache.org/SETTINGS/1.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0 https://maven.apache.org/xsd/settings-1.0.0.xsd"><servers><server><id>${{ parameters.maven_id }}</id><username>${{ parameters.maven_username }}</username><password>${{ parameters.maven_password }}</password></server></servers></settings>' > settings.xml
      workingDirectory: "${{ parameters.project_root_dir }}"
    target:
      container: ${{ parameters.docker_build_container }}
    displayName: Set up the 'settings.xml' for Maven Central Publishing

  # Maven: Performing a Deployment to Maven Central
  - task: Bash@3
    inputs:
      targetType: inline
      script: |
        ./mvnw deploy --no-transfer-progress --settings settings.xml -DdeploymentName="${{ parameters.project_type }} @ ${{ parameters.maven_package_version }}"
      workingDirectory: "${{ parameters.project_root_dir }}"
    target:
      container: ${{ parameters.docker_build_container }}
    displayName: "Maven: Deploy Application to Maven Central (${{ parameters.project_type }})"
