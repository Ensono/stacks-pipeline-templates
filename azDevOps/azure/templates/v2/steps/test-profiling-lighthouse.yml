############################################################################################################
# desc: Runs the lighthouse ci in a docker container.
# return:
# inputs:
#    - working_directory
#    - target_container (see amidostacks/lhci)
#    - lighthouse_config_filename: name of the lighthouse config file, eg. lighthouserc.json
#    - lighthouse_command: commands to run as configured in the config file, e.g. collect, assert, server
#    - lighthouse_urls: list/array of urls to run on, overiding defaults in config file. eg. - google.com
# pre-reqs: Deployed webapp on a given URL
############################################################################################################

parameters:
  working_directory: ''
  target_container: ''
  lighthouse_config_filename: ''
  lighthouse_commands: []
  lighthouse_urls: []

  steps:
    # Lighthouse commands
    # - ${{ each url in parameters.lighthouse_urls }}:
    - ${{ each command in parameters.lighthouse_commands }}:
        - bash: |
            lhci ${{ command }} --config=${{ parameters.lighthouse_config_filename }}
          displayName: "Lighthouse Audit: lhci ${{ command }}"
          target:
            container: ${{ parameters.target_container }}
          workingDirectory: ${{ parameters.working_directory }}
          # env:
          #   LHCI_URL: ${{ parameters.lighthouse_urls }}

    # Publish the results to the pipeline
    - task: PublishPipelineArtifact@1
      displayName: 'Publish Lighthouse reports'
      inputs:
        targetPath: '$(Build.SourcesDirectory)${{parameters.working_directory}}/.lighthouseci'
        artifact: 'Lighthouse CI - Results $(Build.BuildNumber)'
